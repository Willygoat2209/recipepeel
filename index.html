<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RecipePeel ‚Äî Just the Recipe</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçã</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #faf6ef;
    --paper: #f2ead8;
    --bark: #2c1f0e;
    --terracotta: #c85a2a;
    --sage: #6b7c5c;
    --gold: #d4a243;
    --ink: #1a1208;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
  }

  /* Noise texture overlay */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .hero {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 60px 20px 40px;
    border-bottom: 2px solid var(--paper);
  }

  .logo-mark {
    display: inline-block;
    width: 52px;
    height: 52px;
    background: var(--terracotta);
    border-radius: 50% 50% 50% 8px;
    margin-bottom: 16px;
    position: relative;
  }
  .logo-mark::after {
    content: 'üçã';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -52%);
    font-size: 24px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 6vw, 4rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--bark);
    line-height: 1.1;
  }

  h1 em {
    font-style: italic;
    color: var(--terracotta);
  }

  .tagline {
    margin-top: 10px;
    font-size: 1rem;
    color: var(--sage);
    font-weight: 300;
    letter-spacing: 0.04em;
  }

  /* Input zone */
  .input-zone {
    position: relative;
    z-index: 1;
    max-width: 700px;
    margin: 48px auto 20px;
    padding: 0 20px;
  }

  .url-wrap {
    display: flex;
    background: white;
    border: 2px solid var(--paper);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(44,31,14,0.08);
    transition: border-color 0.2s, box-shadow 0.2s;
  }

  .url-wrap:focus-within {
    border-color: var(--terracotta);
    box-shadow: 0 4px 32px rgba(200,90,42,0.15);
  }

  #urlInput {
    flex: 1;
    border: none;
    outline: none;
    padding: 18px 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    color: var(--ink);
    background: transparent;
  }

  #urlInput::placeholder { color: #b8a98a; }

  #fetchBtn {
    background: var(--terracotta);
    color: white;
    border: none;
    padding: 0 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    letter-spacing: 0.02em;
  }

  #fetchBtn:hover { background: #b54d22; }
  #fetchBtn:active { transform: scale(0.98); }
  #fetchBtn:disabled { background: #c9a98a; cursor: not-allowed; }

  .hint {
    text-align: center;
    font-size: 0.82rem;
    color: #a89070;
    margin-top: 10px;
    font-weight: 300;
  }

  /* Status */
  #status {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 16px;
    font-size: 0.95rem;
    color: var(--sage);
    min-height: 40px;
  }

  .spinner {
    display: inline-block;
    width: 18px; height: 18px;
    border: 2px solid var(--paper);
    border-top-color: var(--terracotta);
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
    vertical-align: middle;
    margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Recipe output */
  #output {
    position: relative;
    z-index: 1;
    max-width: 760px;
    margin: 0 auto 80px;
    padding: 0 20px;
    animation: fadeUp 0.5s ease both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .recipe-card {
    background: white;
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 8px 40px rgba(44,31,14,0.1);
    border: 1px solid var(--paper);
  }

  .recipe-header {
    background: var(--bark);
    padding: 36px 40px 32px;
    color: white;
    position: relative;
    overflow: hidden;
  }

  .recipe-header::before {
    content: '';
    position: absolute;
    top: -40px; right: -40px;
    width: 160px; height: 160px;
    background: var(--terracotta);
    opacity: 0.15;
    border-radius: 50%;
  }

  .recipe-source {
    font-size: 0.78rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--gold);
    margin-bottom: 10px;
    font-weight: 500;
  }

  .recipe-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.6rem, 4vw, 2.4rem);
    font-weight: 700;
    line-height: 1.2;
  }

  .recipe-meta {
    display: flex;
    gap: 24px;
    margin-top: 16px;
    flex-wrap: wrap;
  }

  .meta-item {
    font-size: 0.85rem;
    color: rgba(255,255,255,0.7);
  }
  .meta-item strong { color: white; display: block; font-size: 1rem; }

  .recipe-body {
    padding: 36px 40px;
    display: grid;
    gap: 36px;
  }

  @media (min-width: 600px) {
    .recipe-body { grid-template-columns: 260px 1fr; }
  }

  .section-label {
    font-size: 0.72rem;
    letter-spacing: 0.14em;
    text-transform: uppercase;
    color: var(--terracotta);
    font-weight: 500;
    margin-bottom: 14px;
  }

  .ingredients-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .ingredients-list li {
    font-size: 0.93rem;
    line-height: 1.5;
    padding: 8px 12px;
    background: var(--cream);
    border-radius: 6px;
    color: var(--bark);
    border-left: 3px solid var(--gold);
  }

  .instructions-list {
    list-style: none;
    display: flex;
    flex-direction: column;
    gap: 16px;
  }

  .instructions-list li {
    display: flex;
    gap: 14px;
    font-size: 0.95rem;
    line-height: 1.65;
    color: var(--ink);
  }

  .step-num {
    flex-shrink: 0;
    width: 28px; height: 28px;
    background: var(--terracotta);
    color: white;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.78rem;
    font-weight: 500;
    margin-top: 2px;
  }

  .notes-box {
    background: #fffbf0;
    border: 1px solid #e8d9b0;
    border-radius: 10px;
    padding: 20px;
    font-size: 0.9rem;
    line-height: 1.7;
    color: var(--bark);
  }

  .copy-btn {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: transparent;
    border: 1.5px solid var(--sage);
    color: var(--sage);
    border-radius: 8px;
    padding: 8px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    cursor: pointer;
    transition: all 0.2s;
    margin-top: 8px;
  }
  .copy-btn:hover { background: var(--sage); color: white; }

  .error-msg {
    background: #fff5f2;
    border: 1.5px solid #f4c4b0;
    border-radius: 12px;
    padding: 24px;
    text-align: center;
    color: var(--terracotta);
    font-size: 0.95rem;
  }
  .error-msg strong { display: block; margin-bottom: 6px; font-size: 1.05rem; }
</style>
</head>
<body>

<div class="hero">
  <div class="logo-mark"></div>
  <h1>Recipe<em>Peel</em></h1>
  <p class="tagline">paste a link. get just the recipe. no life stories, no ads, no scrolling.</p>
</div>

<div class="input-zone">
  <div class="url-wrap">
    <input type="url" id="urlInput" placeholder="https://somefoodblog.com/the-best-chocolate-cake-ever..." autocomplete="off" />
    <button id="fetchBtn" onclick="fetchRecipe()">Extract Recipe ‚Üí</button>
  </div>
  <p class="hint">Works with most recipe blogs, AllRecipes, Food Network, NYT Cooking, and more.</p>
</div>

<div id="status"></div>
<div id="output"></div>

<script>
async function fetchRecipe() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;

  const btn = document.getElementById('fetchBtn');
  const status = document.getElementById('status');
  const output = document.getElementById('output');

  btn.disabled = true;
  output.innerHTML = '';
  status.innerHTML = '<span class="spinner"></span> Fetching page...';

  try {
    // Use allorigins proxy to bypass CORS
    const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
    const resp = await fetch(proxyUrl);
    if (!resp.ok) throw new Error('Could not fetch page');
    const data = await resp.json();
    const html = data.contents;

    status.innerHTML = '<span class="spinner"></span> Extracting recipe with AI...';

    // Parse the page and extract text
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');

    // Try JSON-LD schema first (most reliable)
    let recipeData = null;
    const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
    for (const script of scripts) {
      try {
        let json = JSON.parse(script.textContent);
        if (Array.isArray(json)) json = json[0];
        if (json['@graph']) json = json['@graph'].find(n => n['@type'] === 'Recipe' || (Array.isArray(n['@type']) && n['@type'].includes('Recipe'))) || json['@graph'][0];
        if (json['@type'] === 'Recipe' || (Array.isArray(json['@type']) && json['@type'].includes('Recipe'))) {
          recipeData = json;
          break;
        }
      } catch(e) {}
    }

    if (recipeData) {
      renderStructuredRecipe(recipeData, url);
    } else {
      // Fall back to AI extraction
      const pageText = extractPageText(doc);
      await extractWithAI(pageText, url);
    }
  } catch(err) {
    status.innerHTML = '';
    output.innerHTML = `<div class="error-msg"><strong>Couldn't load that page.</strong>Some sites block external access. Try copying the page content and pasting it instead, or try a different recipe URL.</div>`;
  }

  btn.disabled = false;
}

function extractPageText(doc) {
  // Remove noise
  ['script','style','nav','header','footer','aside','.ads','.comments','#comments'].forEach(sel => {
    doc.querySelectorAll(sel).forEach(el => el.remove());
  });
  return (doc.body?.innerText || doc.body?.textContent || '').replace(/\s+/g, ' ').slice(0, 30000);
}

function renderStructuredRecipe(data, sourceUrl) {
  const status = document.getElementById('status');
  const output = document.getElementById('output');
  status.innerHTML = '';

  const title = data.name || 'Recipe';
  const sourceHost = (() => { try { return new URL(sourceUrl).hostname.replace('www.',''); } catch(e) { return sourceUrl; } })();

  const ingredients = (data.recipeIngredient || []).map(i => `<li>${i}</li>`).join('');

  let instructions = [];
  if (data.recipeInstructions) {
    if (typeof data.recipeInstructions === 'string') {
      instructions = data.recipeInstructions.split(/\n+/).filter(s => s.trim());
    } else if (Array.isArray(data.recipeInstructions)) {
      for (const item of data.recipeInstructions) {
        if (typeof item === 'string') {
          instructions.push(item);
        } else if (item['@type'] === 'HowToSection' && Array.isArray(item.itemListElement)) {
          // Section with sub-steps ‚Äî include section name + all steps
          if (item.name) instructions.push('‚îÄ‚îÄ ' + item.name + ' ‚îÄ‚îÄ');
          for (const sub of item.itemListElement) {
            const txt = typeof sub === 'string' ? sub : (sub.text || sub.name || '');
            if (txt) instructions.push(txt);
          }
        } else {
          const txt = item.text || item.name || '';
          if (txt) instructions.push(txt);
        }
      }
    }
  }
  let stepCounter = 0;
  const stepsHtml = instructions.map((step) => {
    if (step.startsWith('‚îÄ‚îÄ ')) {
      return `<li style="list-style:none"><span style="display:block;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--sage);font-weight:500;padding:8px 0 4px;border-top:1px solid var(--paper);margin-top:8px">${step.replace(/‚îÄ‚îÄ\s*/g,'').replace(/\s*‚îÄ‚îÄ$/,'')}</span></li>`;
    }
    stepCounter++;
    return `<li><span class="step-num">${stepCounter}</span><span>${step}</span></li>`;
  }).join('');

  const prepTime = formatTime(data.prepTime);
  const cookTime = formatTime(data.cookTime);
  const servings = data.recipeYield ? (Array.isArray(data.recipeYield) ? data.recipeYield[0] : data.recipeYield) : null;
  const notes = data.description || '';

  const metaHtml = [
    prepTime ? `<div class="meta-item"><strong>${prepTime}</strong>Prep</div>` : '',
    cookTime ? `<div class="meta-item"><strong>${cookTime}</strong>Cook</div>` : '',
    servings ? `<div class="meta-item"><strong>${servings}</strong>Servings</div>` : '',
  ].join('');

  output.innerHTML = `
    <div class="recipe-card">
      <div class="recipe-header">
        <div class="recipe-source">${sourceHost}</div>
        <div class="recipe-title">${title}</div>
        ${metaHtml ? `<div class="recipe-meta">${metaHtml}</div>` : ''}
      </div>
      <div class="recipe-body">
        <div class="ingredients-section">
          <div class="section-label">Ingredients</div>
          <ul class="ingredients-list">${ingredients || '<li>No ingredients found</li>'}</ul>
        </div>
        <div class="instructions-section">
          <div class="section-label">Instructions</div>
          <ol class="instructions-list">${stepsHtml || '<li><span class="step-num">!</span><span>No instructions found in structured data.</span></li>'}</ol>
          ${notes ? `<div class="notes-box" style="margin-top:20px"><strong style="display:block;margin-bottom:6px;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--terracotta)">Notes</strong>${notes}</div>` : ''}
          <button class="copy-btn" onclick="copyRecipe()">üìã Copy recipe</button>
        </div>
      </div>
    </div>
  `;
}

function formatTime(iso) {
  if (!iso) return null;
  const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
  if (!m) return iso;
  const h = parseInt(m[1]||0), min = parseInt(m[2]||0);
  if (h && min) return `${h}h ${min}m`;
  if (h) return `${h} hr`;
  if (min) return `${min} min`;
  return null;
}

async function extractWithAI(text, sourceUrl) {
  const status = document.getElementById('status');
  const output = document.getElementById('output');

  const response = await fetch("https://api.anthropic.com/v1/messages", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      model: "claude-sonnet-4-20250514",
      max_tokens: 4000,
      messages: [{
        role: "user",
        content: `Extract the recipe from this webpage text. Return ONLY a JSON object with these fields:
{
  "title": "recipe name",
  "prepTime": "e.g. 15 minutes",
  "cookTime": "e.g. 30 minutes",
  "servings": "e.g. 4 servings",
  "ingredients": ["ingredient 1", "ingredient 2", ...],
  "instructions": ["step 1 full text", "step 2 full text", ...],
  "notes": "any tips or notes (optional)"
}

CRITICAL RULES:
- Copy the instructions WORD FOR WORD exactly as written on the page. Do NOT summarize, shorten, or paraphrase any step. Every detail, temperature, time, and technique must be preserved exactly.
- Copy the ingredients exactly as listed including all quantities and descriptors.
- If a field is not found, omit it.
- Return only valid JSON, no other text, no markdown fences.

Page text:
${text}`
      }]
    })
  });

  const data = await response.json();
  const raw = data.content?.map(b => b.text || '').join('').replace(/```json|```/g,'').trim();

  let recipe;
  try { recipe = JSON.parse(raw); }
  catch(e) {
    status.innerHTML = '';
    output.innerHTML = `<div class="error-msg"><strong>Couldn't extract a recipe from this page.</strong>This might not be a recipe page, or the content couldn't be parsed. Try a different URL.</div>`;
    return;
  }

  status.innerHTML = '';
  const sourceHost = (() => { try { return new URL(sourceUrl).hostname.replace('www.',''); } catch(e) { return ''; } })();

  const ingredients = (recipe.ingredients || []).map(i => `<li>${i}</li>`).join('');
  const stepsHtml = (recipe.instructions || []).map((step, i) => `<li><span class="step-num">${i+1}</span><span>${step}</span></li>`).join('');

  const metaHtml = [
    recipe.prepTime ? `<div class="meta-item"><strong>${recipe.prepTime}</strong>Prep</div>` : '',
    recipe.cookTime ? `<div class="meta-item"><strong>${recipe.cookTime}</strong>Cook</div>` : '',
    recipe.servings ? `<div class="meta-item"><strong>${recipe.servings}</strong>Servings</div>` : '',
  ].join('');

  output.innerHTML = `
    <div class="recipe-card">
      <div class="recipe-header">
        ${sourceHost ? `<div class="recipe-source">${sourceHost}</div>` : ''}
        <div class="recipe-title">${recipe.title || 'Recipe'}</div>
        ${metaHtml ? `<div class="recipe-meta">${metaHtml}</div>` : ''}
      </div>
      <div class="recipe-body">
        <div>
          <div class="section-label">Ingredients</div>
          <ul class="ingredients-list">${ingredients}</ul>
        </div>
        <div>
          <div class="section-label">Instructions</div>
          <ol class="instructions-list">${stepsHtml}</ol>
          ${recipe.notes ? `<div class="notes-box" style="margin-top:20px"><strong style="display:block;margin-bottom:6px;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--terracotta)">Notes</strong>${recipe.notes}</div>` : ''}
          <button class="copy-btn" onclick="copyRecipe()">üìã Copy recipe</button>
        </div>
      </div>
    </div>
  `;
}

function copyRecipe() {
  const card = document.querySelector('.recipe-card');
  if (!card) return;
  const title = card.querySelector('.recipe-title')?.textContent || '';
  const ingredients = [...card.querySelectorAll('.ingredients-list li')].map(li => '‚Ä¢ ' + li.textContent).join('\n');
  const steps = [...card.querySelectorAll('.instructions-list li')].map((li, i) => `${i+1}. ${li.querySelector('span:last-child')?.textContent || li.textContent}`).join('\n');
  const notes = card.querySelector('.notes-box')?.textContent || '';
  const text = `${title}\n\nINGREDIENTS\n${ingredients}\n\nINSTRUCTIONS\n${steps}${notes ? '\n\nNOTES\n'+notes : ''}`;
  navigator.clipboard.writeText(text).then(() => {
    const btn = document.querySelector('.copy-btn');
    btn.textContent = '‚úì Copied!';
    setTimeout(() => btn.innerHTML = 'üìã Copy recipe', 2000);
  });
}

// Allow pressing Enter to trigger
document.getElementById('urlInput').addEventListener('keydown', e => {
  if (e.key === 'Enter') fetchRecipe();
});
</script>
</body>
</html>
