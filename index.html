<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RecipePeel ‚Äî Just the Recipe</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üçã</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --cream: #faf6ef;
    --paper: #f2ead8;
    --bark: #2c1f0e;
    --terracotta: #c85a2a;
    --sage: #6b7c5c;
    --gold: #d4a243;
    --ink: #1a1208;
    --heart: #e05a5a;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--cream);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)' opacity='0.04'/%3E%3C/svg%3E");
    pointer-events: none;
    z-index: 0;
    opacity: 0.4;
  }

  .hero {
    position: relative;
    z-index: 1;
    text-align: center;
    padding: 52px 20px 36px;
    border-bottom: 2px solid var(--paper);
  }

  .logo-mark {
    display: inline-block;
    width: 52px; height: 52px;
    background: var(--terracotta);
    border-radius: 50% 50% 50% 8px;
    margin-bottom: 16px;
    position: relative;
  }
  .logo-mark::after {
    content: 'üçã';
    position: absolute;
    top: 50%; left: 50%;
    transform: translate(-50%, -52%);
    font-size: 24px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(2.4rem, 6vw, 4rem);
    font-weight: 700;
    letter-spacing: -0.02em;
    color: var(--bark);
    line-height: 1.1;
  }
  h1 em { font-style: italic; color: var(--terracotta); }

  .tagline {
    margin-top: 10px;
    font-size: 1rem;
    color: var(--sage);
    font-weight: 300;
    letter-spacing: 0.04em;
  }

  .favs-toggle {
    position: absolute;
    top: 24px; right: 24px;
    background: white;
    border: 1.5px solid var(--paper);
    border-radius: 10px;
    padding: 8px 16px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.85rem;
    font-weight: 500;
    color: var(--bark);
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 7px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(44,31,14,0.07);
    z-index: 10;
  }
  .favs-toggle:hover { border-color: var(--heart); color: var(--heart); }
  .favs-badge {
    background: var(--heart);
    color: white;
    border-radius: 99px;
    padding: 1px 7px;
    font-size: 0.72rem;
    font-weight: 600;
    display: none;
  }
  .favs-badge.visible { display: inline-block; }

  .input-zone {
    position: relative;
    z-index: 1;
    max-width: 700px;
    margin: 44px auto 20px;
    padding: 0 20px;
  }

  .url-wrap {
    display: flex;
    background: white;
    border: 2px solid var(--paper);
    border-radius: 12px;
    overflow: hidden;
    box-shadow: 0 4px 24px rgba(44,31,14,0.08);
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .url-wrap:focus-within {
    border-color: var(--terracotta);
    box-shadow: 0 4px 32px rgba(200,90,42,0.15);
  }

  #urlInput {
    flex: 1;
    border: none;
    outline: none;
    padding: 18px 20px;
    font-family: 'DM Sans', sans-serif;
    font-size: 1rem;
    color: var(--ink);
    background: transparent;
  }
  #urlInput::placeholder { color: #b8a98a; }

  #fetchBtn {
    background: var(--terracotta);
    color: white;
    border: none;
    padding: 0 28px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.95rem;
    font-weight: 500;
    cursor: pointer;
    transition: background 0.2s, transform 0.1s;
    white-space: nowrap;
    letter-spacing: 0.02em;
  }
  #fetchBtn:hover { background: #b54d22; }
  #fetchBtn:active { transform: scale(0.98); }
  #fetchBtn:disabled { background: #c9a98a; cursor: not-allowed; }

  .hint {
    text-align: center;
    font-size: 0.82rem;
    color: #a89070;
    margin-top: 10px;
    font-weight: 300;
  }

  .paste-panel {
    display: none;
    margin-top: 20px;
    background: white;
    border: 2px solid var(--gold);
    border-radius: 12px;
    padding: 20px;
    box-shadow: 0 4px 20px rgba(44,31,14,0.07);
    animation: fadeUp 0.3s ease both;
  }
  .paste-panel.visible { display: block; }
  .paste-panel-title { font-size: 0.92rem; font-weight: 500; color: var(--bark); margin-bottom: 6px; }
  .paste-panel-hint { font-size: 0.8rem; color: #a89070; margin-bottom: 12px; line-height: 1.6; }
  .paste-panel-hint ol { padding-left: 18px; margin-top: 4px; }
  .paste-panel-hint li { margin-bottom: 2px; }
  #pasteText {
    width: 100%; height: 130px;
    border: 1.5px solid var(--paper);
    border-radius: 8px;
    padding: 12px;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.88rem;
    color: var(--ink);
    resize: vertical;
    outline: none;
    transition: border-color 0.2s;
  }
  #pasteText:focus { border-color: var(--terracotta); }
  #pasteText::placeholder { color: #c4b49a; }
  .paste-submit-row { display: flex; justify-content: flex-end; margin-top: 10px; }
  #pasteBtn {
    background: var(--bark); color: white; border: none;
    border-radius: 8px; padding: 10px 22px;
    font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500;
    cursor: pointer; transition: background 0.2s;
  }
  #pasteBtn:hover { background: var(--terracotta); }
  #pasteBtn:disabled { background: #c9a98a; cursor: not-allowed; }

  #status {
    position: relative; z-index: 1;
    text-align: center; padding: 16px;
    font-size: 0.95rem; color: var(--sage); min-height: 40px;
  }
  .spinner {
    display: inline-block; width: 18px; height: 18px;
    border: 2px solid var(--paper); border-top-color: var(--terracotta);
    border-radius: 50%; animation: spin 0.7s linear infinite;
    vertical-align: middle; margin-right: 8px;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  #output {
    position: relative; z-index: 1;
    max-width: 760px; margin: 0 auto 80px; padding: 0 20px;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .recipe-card {
    background: white; border-radius: 16px; overflow: hidden;
    box-shadow: 0 8px 40px rgba(44,31,14,0.1); border: 1px solid var(--paper);
    animation: fadeUp 0.5s ease both;
  }

  .recipe-header {
    background: var(--bark); padding: 36px 40px 32px;
    color: white; position: relative; overflow: hidden;
  }
  .recipe-header::before {
    content: ''; position: absolute; top: -40px; right: -40px;
    width: 160px; height: 160px; background: var(--terracotta); opacity: 0.15; border-radius: 50%;
  }

  .recipe-header-top {
    display: flex; justify-content: space-between; align-items: flex-start; gap: 16px;
  }

  .recipe-source {
    font-size: 0.78rem; letter-spacing: 0.1em; text-transform: uppercase;
    color: var(--gold); margin-bottom: 10px; font-weight: 500;
  }
  .recipe-title {
    font-family: 'Playfair Display', serif;
    font-size: clamp(1.6rem, 4vw, 2.4rem);
    font-weight: 700; line-height: 1.2;
  }
  .recipe-meta { display: flex; gap: 24px; margin-top: 16px; flex-wrap: wrap; }
  .meta-item { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
  .meta-item strong { color: white; display: block; font-size: 1rem; }

  .fav-btn {
    flex-shrink: 0;
    background: rgba(255,255,255,0.12);
    border: 1.5px solid rgba(255,255,255,0.25);
    border-radius: 50%;
    width: 48px; height: 48px;
    display: flex; align-items: center; justify-content: center;
    font-size: 1.4rem; cursor: pointer;
    transition: all 0.2s; position: relative; z-index: 1;
    margin-top: 4px; line-height: 1;
  }
  .fav-btn:hover { background: rgba(224,90,90,0.3); border-color: var(--heart); transform: scale(1.1); }
  .fav-btn.saved { background: var(--heart); border-color: var(--heart); }
  .fav-btn.saved:hover { background: #c94c4c; }

  @keyframes heartPop {
    0%   { transform: scale(1); }
    40%  { transform: scale(1.45); }
    70%  { transform: scale(0.9); }
    100% { transform: scale(1); }
  }
  .fav-btn.pop { animation: heartPop 0.35s ease; }

  .recipe-body { padding: 36px 40px; display: grid; gap: 36px; }
  @media (min-width: 600px) { .recipe-body { grid-template-columns: 260px 1fr; } }

  .section-label {
    font-size: 0.72rem; letter-spacing: 0.14em; text-transform: uppercase;
    color: var(--terracotta); font-weight: 500; margin-bottom: 14px;
  }

  .ingredients-list { list-style: none; display: flex; flex-direction: column; gap: 8px; }
  .ingredients-list li {
    font-size: 0.93rem; line-height: 1.5; padding: 8px 12px;
    background: var(--cream); border-radius: 6px; color: var(--bark);
    border-left: 3px solid var(--gold);
  }

  .instructions-list { list-style: none; display: flex; flex-direction: column; gap: 16px; }
  .instructions-list li { display: flex; gap: 14px; font-size: 0.95rem; line-height: 1.65; color: var(--ink); }
  .step-num {
    flex-shrink: 0; width: 28px; height: 28px;
    background: var(--terracotta); color: white; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    font-size: 0.78rem; font-weight: 500; margin-top: 2px;
  }

  .notes-box {
    background: #fffbf0; border: 1px solid #e8d9b0; border-radius: 10px;
    padding: 20px; font-size: 0.9rem; line-height: 1.7; color: var(--bark);
  }

  .action-row { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
  .copy-btn {
    display: inline-flex; align-items: center; gap: 6px;
    background: transparent; border: 1.5px solid var(--sage); color: var(--sage);
    border-radius: 8px; padding: 8px 16px;
    font-family: 'DM Sans', sans-serif; font-size: 0.85rem; cursor: pointer; transition: all 0.2s;
  }
  .copy-btn:hover { background: var(--sage); color: white; }

  .error-msg {
    background: #fff5f2; border: 1.5px solid #f4c4b0; border-radius: 12px;
    padding: 24px; text-align: center; color: var(--terracotta); font-size: 0.95rem;
  }
  .error-msg strong { display: block; margin-bottom: 6px; font-size: 1.05rem; }

  /* ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ */
  .drawer-overlay {
    display: none; position: fixed; inset: 0;
    background: rgba(26,18,8,0.45); z-index: 100; backdrop-filter: blur(2px);
  }
  .drawer-overlay.open { display: block; }

  .drawer {
    position: fixed; top: 0; right: 0;
    width: min(420px, 100vw); height: 100vh;
    background: var(--cream); z-index: 101;
    display: flex; flex-direction: column;
    transform: translateX(100%);
    transition: transform 0.35s cubic-bezier(0.4,0,0.2,1);
    box-shadow: -8px 0 40px rgba(44,31,14,0.15);
  }
  .drawer.open { transform: translateX(0); }

  .drawer-header {
    padding: 28px 24px 20px; border-bottom: 2px solid var(--paper);
    display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
  }
  .drawer-title {
    font-family: 'Playfair Display', serif; font-size: 1.4rem;
    font-weight: 700; color: var(--bark); display: flex; align-items: center; gap: 10px;
  }
  .drawer-close {
    background: none; border: none; font-size: 1.4rem;
    cursor: pointer; color: var(--sage); transition: color 0.2s; padding: 4px; line-height: 1;
  }
  .drawer-close:hover { color: var(--bark); }

  .drawer-body { flex: 1; overflow-y: auto; padding: 16px; }

  .drawer-empty { text-align: center; padding: 60px 20px; color: #b8a98a; }
  .drawer-empty .ei { font-size: 3rem; margin-bottom: 12px; }
  .drawer-empty p { font-size: 0.95rem; line-height: 1.6; }

  .saved-card {
    background: white; border: 1.5px solid var(--paper); border-radius: 12px;
    padding: 16px; margin-bottom: 12px; cursor: pointer;
    transition: all 0.2s; position: relative;
  }
  .saved-card:hover { border-color: var(--terracotta); box-shadow: 0 4px 16px rgba(44,31,14,0.08); }
  .saved-card-source { font-size: 0.72rem; letter-spacing: 0.08em; text-transform: uppercase; color: var(--gold); font-weight: 500; margin-bottom: 4px; }
  .saved-card-title { font-family: 'Playfair Display', serif; font-size: 1.05rem; font-weight: 700; color: var(--bark); line-height: 1.3; margin-bottom: 6px; padding-right: 32px; }
  .saved-card-meta { font-size: 0.78rem; color: #a89070; }
  .saved-card-del {
    position: absolute; top: 14px; right: 14px;
    background: none; border: none; font-size: 1rem;
    cursor: pointer; color: #c4b49a; transition: color 0.2s; padding: 2px; line-height: 1;
  }
  .saved-card-del:hover { color: var(--heart); }

  .drawer-footer { padding: 16px; border-top: 2px solid var(--paper); flex-shrink: 0; }
  .clear-all-btn {
    width: 100%; background: none; border: 1.5px solid #e8d9b0; border-radius: 8px;
    padding: 10px; font-family: 'DM Sans', sans-serif; font-size: 0.85rem; color: #a89070;
    cursor: pointer; transition: all 0.2s;
  }
  .clear-all-btn:hover { border-color: var(--heart); color: var(--heart); }
</style>
</head>
<body>

<!-- Favorites Drawer -->
<div class="drawer-overlay" id="drawerOverlay" onclick="closeDrawer()"></div>
<div class="drawer" id="drawer">
  <div class="drawer-header">
    <div class="drawer-title">‚ù§Ô∏è Saved Recipes</div>
    <button class="drawer-close" onclick="closeDrawer()">‚úï</button>
  </div>
  <div class="drawer-body" id="drawerBody"></div>
  <div class="drawer-footer" id="drawerFooter" style="display:none">
    <button class="clear-all-btn" onclick="clearAllFavorites()">Remove all saved recipes</button>
  </div>
</div>

<div class="hero">
  <button class="favs-toggle" onclick="openDrawer()">
    <span>‚ô•</span> Saved <span class="favs-badge" id="favsBadge">0</span>
  </button>
  <div class="logo-mark"></div>
  <h1>Recipe<em>Peel</em></h1>
  <p class="tagline">paste a link. get just the recipe. no life stories, no ads, no scrolling.</p>
</div>

<div class="input-zone">
  <div class="url-wrap">
    <input type="url" id="urlInput" placeholder="https://somefoodblog.com/the-best-chocolate-cake-ever..." autocomplete="off" />
    <button id="fetchBtn" onclick="fetchRecipe()">Extract Recipe ‚Üí</button>
  </div>
  <p class="hint">Works with most recipe blogs, AllRecipes, Food Network, NYT Cooking, and more.</p>
  <div class="paste-panel" id="pastePanel">
    <div class="paste-panel-title">üí° That site blocked automatic fetching ‚Äî here's an easy workaround:</div>
    <div class="paste-panel-hint">
      <ol>
        <li>Open the recipe page in your browser</li>
        <li>Press <strong>Ctrl+A</strong> (or Cmd+A on Mac) to select all, then <strong>Ctrl+C</strong> to copy</li>
        <li>Paste it into the box below</li>
      </ol>
    </div>
    <textarea id="pasteText" placeholder="Paste the full page text here‚Ä¶"></textarea>
    <div class="paste-submit-row">
      <button id="pasteBtn" onclick="extractFromPaste()">Extract Recipe ‚Üí</button>
    </div>
  </div>
</div>

<div id="status"></div>
<div id="output"></div>

<script>
let currentRecipe = null;
// ‚îÄ‚îÄ STORAGE (IndexedDB ‚Äî truly persists across tab closes per device) ‚îÄ‚îÄ
const DB_NAME = 'RecipePeel';
const DB_STORE = 'favorites';
let _db = null;

function openDB() {
  if (_db) return Promise.resolve(_db);
  return new Promise((resolve, reject) => {
    const req = indexedDB.open(DB_NAME, 1);
    req.onupgradeneeded = e => {
      e.target.result.createObjectStore(DB_STORE, { keyPath: 'id' });
    };
    req.onsuccess = e => { _db = e.target.result; resolve(_db); };
    req.onerror = () => reject(req.error);
  });
}

async function loadFavorites() {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const req = tx.objectStore(DB_STORE).getAll();
      req.onsuccess = () => {
        // Sort newest first
        const sorted = (req.result || []).sort((a, b) => (b.savedAt || 0) - (a.savedAt || 0));
        resolve(sorted);
      };
      req.onerror = () => resolve([]);
    });
  } catch(e) { return []; }
}

async function saveFavorite(recipe) {
  try {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      tx.objectStore(DB_STORE).put(recipe);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  } catch(e) { return false; }
}

async function deleteFavoriteById(id) {
  try {
    const db = await openDB();
    return new Promise((resolve) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      tx.objectStore(DB_STORE).delete(id);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  } catch(e) { return false; }
}

async function clearAllDB() {
  try {
    const db = await openDB();
    return new Promise((resolve) => {
      const tx = db.transaction(DB_STORE, 'readwrite');
      tx.objectStore(DB_STORE).clear();
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => resolve(false);
    });
  } catch(e) { return false; }
}

async function isInDB(id) {
  try {
    const db = await openDB();
    return new Promise((resolve) => {
      const tx = db.transaction(DB_STORE, 'readonly');
      const req = tx.objectStore(DB_STORE).get(id);
      req.onsuccess = () => resolve(!!req.result);
      req.onerror = () => resolve(false);
    });
  } catch(e) { return false; }
}

async function refreshBadge() {
  const favs = await loadFavorites();
  const badge = document.getElementById('favsBadge');
  if (favs.length > 0) { badge.textContent = favs.length; badge.classList.add('visible'); }
  else { badge.classList.remove('visible'); }
}

async function isFavorited(id) {
  return isInDB(id);
}

// ‚îÄ‚îÄ DRAWER ‚îÄ‚îÄ
async function openDrawer() {
  document.getElementById('drawer').classList.add('open');
  document.getElementById('drawerOverlay').classList.add('open');
  document.body.style.overflow = 'hidden';
  await renderDrawer();
}

function closeDrawer() {
  document.getElementById('drawer').classList.remove('open');
  document.getElementById('drawerOverlay').classList.remove('open');
  document.body.style.overflow = '';
}

async function renderDrawer() {
  const body = document.getElementById('drawerBody');
  const footer = document.getElementById('drawerFooter');
  body.innerHTML = `<div class="drawer-empty"><div class="ei" style="font-size:1.5rem">‚è≥</div><p>Loading...</p></div>`;

  const favs = await loadFavorites();
  console.log('Drawer opened, favorites count:', favs.length, favs);

  if (favs.length === 0) {
    body.innerHTML = `<div class="drawer-empty"><div class="ei">üçã</div><p>No saved recipes yet.<br>Hit the ‚ô• on any recipe to save it here.<br><br>Your recipes sync across all your devices automatically.</p></div>`;
    footer.style.display = 'none';
    return;
  }
  footer.style.display = 'block';
  body.innerHTML = favs.map(r => {
    const meta = [r.prepTime, r.cookTime, r.servings].filter(Boolean).join(' ¬∑ ');
    return `<div class="saved-card" onclick="loadSaved('${r.id}')">
      <button class="saved-card-del" onclick="event.stopPropagation();delFav('${r.id}')" title="Remove">‚úï</button>
      ${r.source ? `<div class="saved-card-source">${esc(r.source)}</div>` : ''}
      <div class="saved-card-title">${esc(r.title)}</div>
      ${meta ? `<div class="saved-card-meta">${esc(meta)}</div>` : ''}
    </div>`;
  }).join('');
}

async function delFav(id) {
  await deleteFavoriteById(id);
  await renderDrawer();
  await refreshBadge();
  updateHeartBtn(id, false);
}

async function clearAllFavorites() {
  if (!confirm('Remove all saved recipes?')) return;
  await clearAllDB();
  await renderDrawer();
  await refreshBadge();
  const btn = document.getElementById('favBtnMain');
  if (btn) setHeartState(btn, false);
}

function loadSaved(id) {
  loadFavorites().then(favs => {
    const r = favs.find(f => f.id === id);
    if (!r) return;
    currentRecipe = r;
    renderRecipeCard(r);
    closeDrawer();
    setTimeout(() => {
      document.getElementById('output').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }, 200);
  });
}

function updateHeartBtn(id, saved) {
  if (currentRecipe && currentRecipe.id === id) {
    const btn = document.getElementById('favBtnMain');
    if (btn) setHeartState(btn, saved);
  }
}

function setHeartState(btn, saved) {
  if (saved) { btn.classList.add('saved'); btn.textContent = '‚ô•'; btn.title = 'Remove from saved'; }
  else       { btn.classList.remove('saved'); btn.textContent = '‚ô°'; btn.title = 'Save recipe'; }
}

// ‚îÄ‚îÄ HEART CLICK ‚îÄ‚îÄ
async function handleFavClick() {
  if (!currentRecipe) return;
  const btn = document.getElementById('favBtnMain');

  // Pop animation
  btn.classList.remove('pop');
  void btn.offsetWidth;
  btn.classList.add('pop');

  const alreadySaved = await isInDB(currentRecipe.id);

  if (alreadySaved) {
    await deleteFavoriteById(currentRecipe.id);
    setHeartState(btn, false);
  } else {
    await saveFavorite({ ...currentRecipe, savedAt: Date.now() });
    setHeartState(btn, true);
  }
  await refreshBadge();
}

// ‚îÄ‚îÄ RENDER CARD ‚îÄ‚îÄ
async function renderRecipeCard(recipe) {
  document.getElementById('status').innerHTML = '';
  const saved = await isFavorited(recipe.id);

  const ingHtml = (recipe.ingredients || []).map(i => `<li>${esc(i)}</li>`).join('');

  let n = 0;
  const stepsHtml = (recipe.instructions || []).map(step => {
    if (step.startsWith('‚îÄ‚îÄ ')) {
      const label = step.replace(/‚îÄ‚îÄ\s*/g,'').replace(/\s*‚îÄ‚îÄ$/,'');
      return `<li style="list-style:none"><span style="display:block;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--sage);font-weight:500;padding:8px 0 4px;border-top:1px solid var(--paper);margin-top:8px">${esc(label)}</span></li>`;
    }
    n++;
    return `<li><span class="step-num">${n}</span><span>${esc(step)}</span></li>`;
  }).join('');

  const metaHtml = [
    recipe.prepTime ? `<div class="meta-item"><strong>${esc(recipe.prepTime)}</strong>Prep</div>` : '',
    recipe.cookTime ? `<div class="meta-item"><strong>${esc(recipe.cookTime)}</strong>Cook</div>` : '',
    recipe.servings ? `<div class="meta-item"><strong>${esc(String(recipe.servings))}</strong>Servings</div>` : '',
  ].join('');

  document.getElementById('output').innerHTML = `
    <div class="recipe-card">
      <div class="recipe-header">
        <div class="recipe-header-top">
          <div>
            ${recipe.source ? `<div class="recipe-source">${esc(recipe.source)}</div>` : ''}
            <div class="recipe-title">${esc(recipe.title)}</div>
          </div>
          <button class="fav-btn ${saved?'saved':''}" id="favBtnMain"
            onclick="handleFavClick()" title="${saved?'Remove from saved':'Save recipe'}">
            ${saved?'‚ô•':'‚ô°'}
          </button>
        </div>
        ${metaHtml ? `<div class="recipe-meta">${metaHtml}</div>` : ''}
      </div>
      <div class="recipe-body">
        <div>
          <div class="section-label">Ingredients</div>
          <ul class="ingredients-list">${ingHtml || '<li>No ingredients found</li>'}</ul>
        </div>
        <div>
          <div class="section-label">Instructions</div>
          <ol class="instructions-list">${stepsHtml || '<li><span class="step-num">!</span><span>No instructions found.</span></li>'}</ol>
          ${recipe.notes ? `<div class="notes-box" style="margin-top:20px"><strong style="display:block;margin-bottom:6px;font-size:0.78rem;letter-spacing:0.1em;text-transform:uppercase;color:var(--terracotta)">Notes</strong>${esc(recipe.notes)}</div>` : ''}
          <div class="action-row">
            <button class="copy-btn" onclick="copyRecipe()">üìã Copy recipe</button>
          </div>
        </div>
      </div>
    </div>`;
}

function esc(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function makeId(title, source) {
  try { return btoa(encodeURIComponent((source||'')+'::'+title)).slice(0,32); }
  catch(e) { return Math.random().toString(36).slice(2); }
}

// ‚îÄ‚îÄ FETCH ‚îÄ‚îÄ
async function fetchRecipe() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) return;
  const btn = document.getElementById('fetchBtn');
  const status = document.getElementById('status');
  const output = document.getElementById('output');
  const pastePanel = document.getElementById('pastePanel');

  btn.disabled = true;
  output.innerHTML = '';
  currentRecipe = null;
  pastePanel.classList.remove('visible');
  status.innerHTML = '<span class="spinner"></span> Fetching page...';

  const proxies = [
    `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`,
    `https://corsproxy.io/?${encodeURIComponent(url)}`,
    `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  ];

  let html = null;
  for (let i = 0; i < proxies.length; i++) {
    try {
      status.innerHTML = `<span class="spinner"></span> Trying to fetch page (attempt ${i+1} of ${proxies.length})...`;
      const resp = await fetch(proxies[i], { signal: AbortSignal.timeout(10000) });
      if (!resp.ok) continue;
      if (i === 0) {
        const d = await resp.json();
        if (d.contents && d.contents.length > 500) { html = d.contents; break; }
      } else {
        const t = await resp.text();
        if (t && t.length > 500) { html = t; break; }
      }
    } catch(e) {}
  }

  if (!html) {
    status.innerHTML = '';
    output.innerHTML = `<div class="error-msg"><strong>This site blocks automatic fetching.</strong> No worries ‚Äî use the paste method below instead.</div>`;
    pastePanel.classList.add('visible');
    pastePanel.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    btn.disabled = false;
    return;
  }

  status.innerHTML = '<span class="spinner"></span> Extracting recipe...';
  const parser = new DOMParser();
  const doc = parser.parseFromString(html, 'text/html');

  let recipeData = null;
  for (const script of doc.querySelectorAll('script[type="application/ld+json"]')) {
    try {
      let json = JSON.parse(script.textContent);
      if (Array.isArray(json)) json = json[0];
      if (json['@graph']) json = json['@graph'].find(n => n['@type']==='Recipe' || (Array.isArray(n['@type'])&&n['@type'].includes('Recipe'))) || json['@graph'][0];
      if (json['@type']==='Recipe' || (Array.isArray(json['@type'])&&json['@type'].includes('Recipe'))) { recipeData = json; break; }
    } catch(e) {}
  }

  if (recipeData) await processStructuredRecipe(recipeData, url);
  else await extractWithAI(extractPageText(doc), url);

  btn.disabled = false;
}

async function extractFromPaste() {
  const text = document.getElementById('pasteText').value.trim();
  if (!text) return;
  const btn = document.getElementById('pasteBtn');
  btn.disabled = true;
  document.getElementById('output').innerHTML = '';
  currentRecipe = null;
  document.getElementById('status').innerHTML = '<span class="spinner"></span> Extracting recipe from pasted text...';
  await extractWithAI(text.slice(0,30000), document.getElementById('urlInput').value.trim() || '');
  btn.disabled = false;
}

function extractPageText(doc) {
  ['script','style','nav','header','footer','aside'].forEach(s => doc.querySelectorAll(s).forEach(el => el.remove()));
  return (doc.body?.innerText || doc.body?.textContent || '').replace(/\s+/g,' ').slice(0,30000);
}

async function processStructuredRecipe(data, sourceUrl) {
  const sourceHost = (() => { try { return new URL(sourceUrl).hostname.replace('www.',''); } catch(e) { return ''; } })();
  const title = data.name || 'Recipe';
  let instructions = [];
  if (data.recipeInstructions) {
    if (typeof data.recipeInstructions === 'string') {
      instructions = data.recipeInstructions.split(/\n+/).filter(s => s.trim());
    } else if (Array.isArray(data.recipeInstructions)) {
      for (const item of data.recipeInstructions) {
        if (typeof item === 'string') { instructions.push(item); }
        else if (item['@type']==='HowToSection' && Array.isArray(item.itemListElement)) {
          if (item.name) instructions.push('‚îÄ‚îÄ '+item.name+' ‚îÄ‚îÄ');
          for (const sub of item.itemListElement) {
            const t = typeof sub==='string' ? sub : (sub.text||sub.name||'');
            if (t) instructions.push(t);
          }
        } else {
          const t = item.text||item.name||'';
          if (t) instructions.push(t);
        }
      }
    }
  }
  const prepTime = formatTime(data.prepTime);
  const cookTime = formatTime(data.cookTime);
  const sv = data.recipeYield ? (Array.isArray(data.recipeYield) ? data.recipeYield[0] : data.recipeYield) : null;
  currentRecipe = {
    id: makeId(title, sourceHost), title, source: sourceHost,
    prepTime, cookTime, servings: sv ? String(sv) : null,
    ingredients: data.recipeIngredient || [], instructions,
    notes: data.description || '', savedAt: Date.now(),
  };
  await renderRecipeCard(currentRecipe);
}

function formatTime(iso) {
  if (!iso) return null;
  const m = iso.match(/PT(?:(\d+)H)?(?:(\d+)M)?/);
  if (!m) return iso;
  const h = parseInt(m[1]||0), min = parseInt(m[2]||0);
  if (h && min) return `${h}h ${min}m`;
  if (h) return `${h} hr`;
  if (min) return `${min} min`;
  return null;
}

async function extractWithAI(text, sourceUrl) {
  const status = document.getElementById('status');
  const output = document.getElementById('output');
  try {
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 4000,
        messages: [{ role: "user", content: `Extract the recipe from this webpage text. Return ONLY a JSON object:
{
  "title": "recipe name",
  "prepTime": "e.g. 15 minutes",
  "cookTime": "e.g. 30 minutes",
  "servings": "e.g. 4 servings",
  "ingredients": ["ingredient 1", ...],
  "instructions": ["step 1 full text", ...],
  "notes": "tips (optional)"
}
CRITICAL: Copy instructions WORD FOR WORD. Do NOT summarize or shorten any step.
Copy ingredients exactly with all quantities.
Omit fields not found. Return only valid JSON, no markdown.

Page text:
${text}` }]
      })
    });
    const data = await resp.json();
    const raw = data.content?.map(b => b.text||'').join('').replace(/```json|```/g,'').trim();
    let recipe;
    try { recipe = JSON.parse(raw); }
    catch(e) {
      status.innerHTML = '';
      output.innerHTML = `<div class="error-msg"><strong>Couldn't extract a recipe from this page.</strong> This might not be a recipe page. Try a different URL.</div>`;
      return;
    }
    const sourceHost = (() => { try { return new URL(sourceUrl).hostname.replace('www.',''); } catch(e) { return ''; } })();
    const title = recipe.title || 'Recipe';
    currentRecipe = {
      id: makeId(title, sourceHost), title, source: sourceHost,
      prepTime: recipe.prepTime||null, cookTime: recipe.cookTime||null,
      servings: recipe.servings||null,
      ingredients: recipe.ingredients||[], instructions: recipe.instructions||[],
      notes: recipe.notes||'', savedAt: Date.now(),
    };
    await renderRecipeCard(currentRecipe);
  } catch(e) {
    status.innerHTML = '';
    output.innerHTML = `<div class="error-msg"><strong>Something went wrong.</strong> Please try again.</div>`;
  }
}

function copyRecipe() {
  if (!currentRecipe) return;
  const ing = (currentRecipe.ingredients||[]).map(i => '‚Ä¢ '+i).join('\n');
  const steps = (currentRecipe.instructions||[]).filter(s => !s.startsWith('‚îÄ‚îÄ ')).map((s,i) => `${i+1}. ${s}`).join('\n');
  const t = `${currentRecipe.title}\n\nINGREDIENTS\n${ing}\n\nINSTRUCTIONS\n${steps}${currentRecipe.notes?'\n\nNOTES\n'+currentRecipe.notes:''}`;
  navigator.clipboard.writeText(t).then(() => {
    const btn = document.querySelector('.copy-btn');
    if (btn) { btn.textContent = '‚úì Copied!'; setTimeout(() => btn.innerHTML = 'üìã Copy recipe', 2000); }
  });
}

document.getElementById('urlInput').addEventListener('keydown', e => { if (e.key==='Enter') fetchRecipe(); });

// Init ‚Äî open DB and show badge count
openDB().then(() => refreshBadge()).catch(() => refreshBadge());
</script>
</body>
</html>
